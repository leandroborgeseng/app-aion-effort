name: ValidaÃ§Ã£o de Pull Request

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  validate-pr:
    name: Validar Pull Request
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“¦ Instalar pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: ğŸ“¥ Instalar dependÃªncias
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Validar sintaxe TypeScript
        run: pnpm exec tsc --noEmit

      - name: âœ… Validar Prisma Schema
        run: pnpm prisma:generate

      - name: ğŸ—ï¸ Build Frontend
        run: pnpm build

      - name: ğŸ“Š Verificar mudanÃ§as
        run: |
          echo "ğŸ“‹ Arquivos modificados nesta PR:"
          git diff --name-only origin/${{ github.base_ref }}...HEAD | head -20
          
          echo ""
          echo "ğŸ“Š EstatÃ­sticas:"
          echo "  - Total de arquivos: $(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)"
          echo "  - Linhas adicionadas: $(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum+=$1} END {print sum}')"
          echo "  - Linhas removidas: $(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum+=$2} END {print sum}')"

      - name: âš ï¸ Verificar arquivos sensÃ­veis
        run: |
          SENSITIVE_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "\.env|\.key|secrets|password|token" || true)
          if [ -n "$SENSITIVE_FILES" ]; then
            echo "âš ï¸ ATENÃ‡ÃƒO: Arquivos sensÃ­veis detectados na PR:"
            echo "$SENSITIVE_FILES"
            echo "Por favor, certifique-se de que nenhum dado sensÃ­vel estÃ¡ sendo commitado!"
            exit 1
          fi
          echo "âœ… Nenhum arquivo sensÃ­vel detectado"

      - name: âœ… PR validada
        run: |
          echo "âœ… Pull Request validada com sucesso!"
          echo "ğŸ“ Checklist:"
          echo "  âœ… TypeScript compila sem erros"
          echo "  âœ… Prisma schema vÃ¡lido"
          echo "  âœ… Frontend build funciona"
          echo "  âœ… Sem arquivos sensÃ­veis"

