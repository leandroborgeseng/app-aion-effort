name: Deploy Manual (Workflow Dispatch)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente de deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
      force_rebuild:
        description: 'ForÃ§ar rebuild completo?'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  manual-deploy:
    name: Deploy Manual - ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ” Configurar SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸš€ Deploy Manual
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          FORCE_REBUILD: ${{ github.event.inputs.force_rebuild }}
        run: |
          cat > /tmp/manual-deploy.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e
          
          cd $DEPLOY_PATH || exit 1
          
          echo "ðŸš€ DEPLOY MANUAL INICIADO"
          echo "========================="
          echo "Ambiente: ${{ github.event.inputs.environment }}"
          echo "Force Rebuild: $FORCE_REBUILD"
          echo ""
          
          # Backup do banco
          if [ -f "prisma/dev.db" ]; then
            BACKUP_FILE="prisma/dev.db.backup.manual.$(date +%Y%m%d_%H%M%S)"
            cp prisma/dev.db "$BACKUP_FILE"
            echo "âœ… Backup criado: $BACKUP_FILE"
          fi
          
          # Atualizar cÃ³digo
          echo "ðŸ”„ Atualizando cÃ³digo..."
          git fetch origin
          git pull origin main
          
          # Sincronizar schema
          echo "ðŸ”„ Sincronizando schema..."
          docker-compose run --rm backend pnpm prisma:db:push || true
          
          # Rebuild se solicitado
          if [ "$FORCE_REBUILD" = "true" ]; then
            echo "ðŸ”¨ ForÃ§ando rebuild completo..."
            docker-compose build --no-cache backend frontend
            docker-compose up -d backend frontend
          else
            echo "ðŸ”„ Reiniciando serviÃ§os..."
            docker-compose restart backend frontend
          fi
          
          # Aguardar inicializaÃ§Ã£o
          sleep 15
          
          # Verificar status
          echo "ðŸ“Š Status dos serviÃ§os:"
          docker-compose ps
          
          echo "âœ… Deploy manual concluÃ­do!"
          DEPLOY_SCRIPT
          
          chmod +x /tmp/manual-deploy.sh
          scp -o StrictHostKeyChecking=no /tmp/manual-deploy.sh $SSH_USER@$SSH_HOST:/tmp/manual-deploy.sh
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "DEPLOY_PATH=$DEPLOY_PATH FORCE_REBUILD=$FORCE_REBUILD bash /tmp/manual-deploy.sh"

