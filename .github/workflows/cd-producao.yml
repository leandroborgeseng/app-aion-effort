name: CD - Deploy para Produ√ß√£o

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.gitignore'
      - 'README.md'

jobs:
  deploy:
    name: Deploy para Produ√ß√£o
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Necess√°rio para git diff

      - name: üîê Configurar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üîç Verificar conectividade SSH
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo 'Conex√£o SSH OK'"

      - name: üìã Verificar mudan√ßas
        id: changes
        run: |
          echo "Verificando mudan√ßas desde √∫ltimo deploy..."
          HAS_SCHEMA_CHANGES=$(git diff HEAD@{1} HEAD --name-only 2>/dev/null | grep -q "prisma/schema.prisma" && echo "true" || echo "false")
          HAS_FRONTEND_CHANGES=$(git diff HEAD@{1} HEAD --name-only 2>/dev/null | grep -E "src/web|src/utils|Dockerfile.frontend|package.json|pnpm-lock.yaml|vite.config.ts" | wc -l)
          HAS_BACKEND_CHANGES=$(git diff HEAD@{1} HEAD --name-only 2>/dev/null | grep -E "src/server|src/routes|src/middleware|Dockerfile.backend|package.json|pnpm-lock.yaml" | wc -l)
          
          echo "schema_changes=$HAS_SCHEMA_CHANGES" >> $GITHUB_OUTPUT
          echo "frontend_changes=$HAS_FRONTEND_CHANGES" >> $GITHUB_OUTPUT
          echo "backend_changes=$HAS_BACKEND_CHANGES" >> $GITHUB_OUTPUT
          
          echo "üìä Mudan√ßas detectadas:"
          echo "  - Schema Prisma: $HAS_SCHEMA_CHANGES"
          echo "  - Frontend: $HAS_FRONTEND_CHANGES arquivos"
          echo "  - Backend: $HAS_BACKEND_CHANGES arquivos"

      - name: üöÄ Deploy para servidor
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          # Criar script de deploy tempor√°rio
          cat > /tmp/deploy.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e
          
          cd $DEPLOY_PATH || exit 1
          
          echo "üîÑ Atualizando c√≥digo do reposit√≥rio..."
          git fetch origin
          
          # Fazer backup do banco antes de atualizar
          if [ -f "prisma/dev.db" ]; then
            BACKUP_FILE="prisma/dev.db.backup.$(date +%Y%m%d_%H%M%S)"
            cp prisma/dev.db "$BACKUP_FILE"
            echo "‚úÖ Backup criado: $BACKUP_FILE"
          fi
          
          # Resolver conflitos locais no banco
          if ! git diff --quiet prisma/dev.db 2>/dev/null; then
            echo "‚ö†Ô∏è Descartando mudan√ßas locais no banco..."
            git checkout -- prisma/dev.db 2>/dev/null || true
            rm -f prisma/dev.db-journal prisma/dev.db-wal prisma/dev.db-shm
          fi
          
          # Atualizar c√≥digo
          git pull origin main
          
          echo "‚úÖ C√≥digo atualizado"
          
          # Verificar se precisa rebuild baseado nas mudan√ßas
          SCHEMA_CHANGES="${{ steps.changes.outputs.schema_changes }}"
          FRONTEND_CHANGES="${{ steps.changes.outputs.frontend_changes }}"
          BACKEND_CHANGES="${{ steps.changes.outputs.backend_changes }}"
          
          # Sincronizar schema se houver mudan√ßas
          if [ "$SCHEMA_CHANGES" = "true" ]; then
            echo "üîÑ Sincronizando schema do Prisma..."
            docker-compose run --rm backend pnpm prisma:db:push || {
              echo "‚ö†Ô∏è Erro ao sincronizar schema, tentando continuar..."
            }
          fi
          
          # Rebuild se necess√°rio
          REBUILD_NEEDED=false
          
          if [ "$FRONTEND_CHANGES" -gt "0" ]; then
            echo "üî® Rebuildando frontend (mudan√ßas detectadas)..."
            REBUILD_NEEDED=true
          fi
          
          if [ "$BACKEND_CHANGES" -gt "0" ]; then
            echo "üî® Rebuildando backend (mudan√ßas detectadas)..."
            REBUILD_NEEDED=true
          fi
          
          if [ "$REBUILD_NEEDED" = "true" ]; then
            echo "üî® Rebuildando containers..."
            docker-compose build --no-cache backend frontend || {
              echo "‚ùå Erro no build, tentando rebuild individual..."
              docker-compose build --no-cache backend || true
              docker-compose build --no-cache frontend || true
            }
          fi
          
          # Reiniciar servi√ßos
          echo "üîÑ Reiniciando servi√ßos..."
          if [ "$REBUILD_NEEDED" = "true" ]; then
            docker-compose up -d backend frontend
          else
            docker-compose restart backend frontend
          fi
          
          # Aguardar inicializa√ß√£o
          echo "‚è≥ Aguardando servi√ßos inicializarem..."
          sleep 10
          
          # Verificar sa√∫de dos servi√ßos
          echo "üè• Verificando sa√∫de dos servi√ßos..."
          BACKEND_HEALTH=$(docker-compose ps backend | grep -q "Up.*healthy" && echo "OK" || echo "CHECKING")
          FRONTEND_HEALTH=$(docker-compose ps frontend | grep -q "Up.*healthy" && echo "OK" || echo "CHECKING")
          
          echo "  Backend: $BACKEND_HEALTH"
          echo "  Frontend: $FRONTEND_HEALTH"
          
          # Aguardar um pouco mais se ainda estiver inicializando
          if [ "$BACKEND_HEALTH" != "OK" ] || [ "$FRONTEND_HEALTH" != "OK" ]; then
            echo "‚è≥ Aguardando mais 15 segundos..."
            sleep 15
            BACKEND_HEALTH=$(docker-compose ps backend | grep -q "Up" && echo "OK" || echo "FALHOU")
            FRONTEND_HEALTH=$(docker-compose ps frontend | grep -q "Up" && echo "OK" || echo "FALHOU")
          fi
          
          if [ "$BACKEND_HEALTH" != "OK" ] || [ "$FRONTEND_HEALTH" != "OK" ]; then
            echo "‚ö†Ô∏è Alguns servi√ßos podem n√£o estar funcionando corretamente"
            echo "üìã Logs do backend:"
            docker-compose logs --tail=20 backend
            echo "üìã Logs do frontend:"
            docker-compose logs --tail=20 frontend
            exit 1
          fi
          
          echo "‚úÖ Deploy conclu√≠do com sucesso!"
          DEPLOY_SCRIPT
          
          # Enviar e executar script
          chmod +x /tmp/deploy.sh
          scp -o StrictHostKeyChecking=no /tmp/deploy.sh $SSH_USER@$SSH_HOST:/tmp/deploy.sh
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "DEPLOY_PATH=$DEPLOY_PATH bash /tmp/deploy.sh"

      - name: ‚úÖ Verificar deploy
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "üîç Verificando status final dos servi√ßos..."
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "cd $DEPLOY_PATH && docker-compose ps"

      - name: üì¢ Notificar resultado
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Deploy conclu√≠do com sucesso!"
            echo "üåê Aplica√ß√£o dispon√≠vel em: https://av.aion.eng.br"
          else
            echo "‚ùå Deploy falhou! Verifique os logs acima."
          fi

